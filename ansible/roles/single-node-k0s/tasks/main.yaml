# SPDX-FileCopyrightText: 2025 NONE
#
# SPDX-License-Identifier: Unlicense

---
- name: Download k0s binary
  become: true
  ansible.builtin.get_url:
    url: "https://github.com/k0sproject/k0s/releases/download/{{ k0s_version }}/k0s-{{ k0s_version }}-amd64"
    dest: /usr/local/bin/k0s
    mode: '0750'
    owner: root
    group: root
- name: Ensure '/etc/k0s' directory
  become: true
  ansible.builtin.file:
    path: /etc/k0s
    state: directory
    mode: '0755'
- name: Apply k0s configuration
  become: true
  ansible.builtin.template:
    src: "{{ k0s_config_src }}"
    dest: /etc/k0s/k0s.yaml
    mode: '0600'
  vars:
    address: "{{ k0s_address }}"
  notify: Restart k0scontroller
  when: k0s_config_src is defined

- name: Get kubeconfig from k0s
  become: true
  ansible.builtin.command:
    cmd: /usr/local/bin/k0s kubeconfig admin
  register: k0s_kubeconfig
  changed_when: false

- name: Ensure .kube directory exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.kube"
    state: directory
    mode: '0755'

- name: Save kubeconfig to user's home directory
  ansible.builtin.copy:
    content: "{{ k0s_kubeconfig.stdout }}"
    dest: "{{ ansible_user_dir }}/.kube/config"
    mode: '0600'

- name: Apply k0s updateconfig
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('url', k0s_updateconfig_url) | from_yaml }}"
    kubeconfig: "{{ ansible_user_dir }}/.kube/config"
  when: k0s_updateconfig_url is defined
